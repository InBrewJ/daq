#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)
RESULTS=local/lint_results.txt
MINIMUM_SCORE=10
PYLINTRC=$ROOT/.pylintrc

cd $ROOT

echo Saving complete results to $RESULTS
rm -f $RESULTS

failure=
results=
for file in daq/*.py; do
    echo Checking $file >> $RESULTS
    score=$(pylint --rcfile=$PYLINTRC $file 2>&1 | tee -a $RESULTS | fgrep 'Your code has been' | awk '{print $7}')
    echo $file $score
    if [ -n "$score" ]; then
        results=true
        if [ "${score%%.*}" -lt $MINIMUM_SCORE ]; then
            failure=true
        fi
    fi
done

if [ -n "$failure" ]; then
    echo pylint failed to achieve a minimum score of $MINIMUM_SCORE.
    false
fi

if [ -z "$results" ]; then
    echo No results reported, that ain\'t right.
    false
fi

echo Success.
