#!/bin/bash -e

runarg=

if [ ! -f local/system.conf ]; then
    echo Installing local/system.conf...
    mkdir -p local
    cp misc/system.conf local/
fi

# Out with the old, in with the new (use faucet instead).
sudo /etc/init.d/openvswitch-controller stop || true

echo -n "Last DAQ commit "
git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true

echo -n "Last FAUCET commit "
(cd $FAUCET; git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true)

if [ "$SWITCH" == "ext" ]; then
    echo ext_dpid=0x1aeb960541 >> local/system.conf
    bin/external_ovs
    if [ -z "$DEVICES" ]; then
        DEVICES=1
    fi
fi

if [ -n "$DEVICES" ]; then
    count=1
    daq_intf=
    while [ $count -le $DEVICES ]; do
        daq_intf+=,faux-$count
        cmd/faux $count
        count=$(($count+1))
    done
    echo daq_intf=${daq_intf#,} >> local/system.conf
fi

if [ "$BUILD" == in ]; then
    runarg=latest
elif [ "$BUILD" == no -a "$TRAVIS_BRANCH" == release ]; then
    echo Not running tests because no-build on release branch.
    exit 0
fi

echo Running DAQ test...
if [ "$MODE" == "in" ]; then
    cmd/run $runarg -s -a
else
    cmd/exrun -s -a
fi
