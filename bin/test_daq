#!/bin/bash -e

# Out with the old, in with the new (use faucet instead).
sudo /etc/init.d/openvswitch-controller stop || true

if [ ! -f local/system.conf ]; then
    echo Installing local/system.conf...
    mkdir -p local
    cp misc/system.conf local/
fi

echo -n "Last DAQ commit "
git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true

echo -n "Last FAUCET commit "
(cd $FAUCET; git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true)

if [ -n "$DEVICES" ]; then
    count=1
    daq_intf=
    while [ $count -le $DEVICES ]; do
        daq_intf+=,faux-$count
        cmd/faux $count
        count=$(($count+1))
    done
    echo daq_intf=${daq_intf#,} >> local/system.conf
fi

if [ "$SWITCH" == "ext" ]; then
    echo ext_dpid=0x1aeb960541 >> local/system.conf
    bin/external_ovs
fi

echo Running DAQ test...
if [ "$MODE" == "in" ]; then
    cmd/run -s
else
    cmd/exrun -s
fi
