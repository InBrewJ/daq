#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)
INSTDIR=$ROOT/inst
FAUCET_SOCK=faucet_event.sock
EVENT_SOCK=$INSTDIR/$FAUCET_SOCK

cd $ROOT

FAUCET=$(realpath $ROOT/../faucet)

if [ ! -d $FAUCET ]; then
    echo Faucet directory $FAUCET not found.
    false
fi

mkdir -p $INSTDIR
rm -f $EVENT_SOCK

docker ps > /dev/null 2>&1 || service docker start

ovsctl=/usr/share/openvswitch/scripts/ovs-ctl
$ovsctl status || sudo $ovsctl start

runcmd=python
if [ -f .pdbrc ]; then
    echo Found .pdbrc file, using pdb...
    runcmd=pdb
fi


sudo env \
     MININET_LOGLEVEL=$MININET_LOGLEVEL \
     DAQ_LOGLEVEL=$DAQ_LOGLEVEL \
     DAQ_CONTAINER=$DAQ_CONTAINER \
     FAUCET_EVENT_SOCK=$EVENT_SOCK \
     PYTHONPATH=$FAUCET \
     TERM=dumb $runcmd daq/daq.py
