#!/bin/bash -e

ROOT=$(dirname $0)/..
cd $ROOT

local_config=local/system.conf
build_root=build
in_container=$DAQ_CONTAINER
build_args=
skip_inception=

if [ "$1" == '-s' ]; then
    skip_inception=y
    shift
fi

if [ -f $local_config ]; then
  echo Loading build configuraiton from $local_config
  source $local_config
fi

if [ -n "$in_container" ]; then
    service docker start
    sleep 1
    echo Importing current local version of daq...
    ROOT=/root/daq
    rm -rf $ROOT
    cp -a /daq $ROOT
    cd $ROOT
    rm -rf build inst
    echo Now running in `pwd`
fi

mkdir -p local
date > local/last_build.txt
sudo rm -rf $build_root
mkdir -p $build_root

declare -A modules

for file in docker/Dockerfile.*; do
    if [ ${file%\~} != ${file} ]; then
        continue
    fi
    module=${file#docker/Dockerfile.}
    if [ $module == base -a -n "$in_container" ]; then
        continue
    fi
    logfile=$build_root/docker_build.$module
    echo Building $file into daq/$module, log to $logfile...
    failed=
    tag=daq/$module
    docker build -t $tag $build_args -f $file . > $logfile 2>&1 || failed=y
    if [ -n "$failed" ]; then
        tail $logfile
        false
    fi
    echo Build complete. >> $logfile
    modules[$module]=$module
done

if [ -z "$in_container" ]; then
    images=$(docker images | fgrep daq/ | awk '{print $1}')
    if [ "${images#daq/runner}" != "${images}" ]; then
        echo Docker image daq/runner up-to-date.
    elif [ -n "$skip_inception" ]; then
        echo Skipping build-in-build inception.
    else
        echo
        echo You can stop this now if running direct with cmd/run and not cmd/dockrun.
        echo
        if [ "${images#*daq/runner*daq/base}" == "${images}" ]; then
            echo Runner build on top of base...
            # Explicilty run in / not /root because of volume mapping.
            cmd/dockrun base /daq/cmd/build
        else
            echo Runner build inside existing runner...
            cmd/dockrun runner daq/cmd/build
        fi
        echo Committing runner container image to daq/runner...
        docker commit -c "CMD daq/cmd/run" daq-runner daq/runner > /dev/null
    fi
else
    docker system prune -f | fgrep reclaimed
    sleep 1
    service docker stop
    sleep 2
    rm -fr /var/lib/docker/runtimes
fi
