#!/bin/bash

echo Starting faux device at `date` with $*

declare -A options
for option in $*; do
    options[$option]=$option
done

while ! ifconfig -a | fgrep -q faux-eth0; do
    echo Waiting for faux-eth0 to exist...
    sleep 1
done

ip addr show faux-eth0

echo Running dhclient...
dhclient
ip addr show faux-eth0

if [ -n "${options[ndhcp]}" ]; then
    echo Chaning assigned ip address...
    ip addr del $(ip addr show faux-eth0 | fgrep inet | awk '{print $2}') dev faux-eth0
    ip addr add 10.0.0.5/8 dev faux-eth0
    ip addr show faux-eth0
fi

# Setup dummy telnet listener to trigger port-scan failure
if [ -n "${options[telnet]}" ]; then
    echo Enabling mock telnet server...
    nc -lk -p 23 -e date &
fi

echo Blocking for all eternety.
tail -f /dev/null
